<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - OpenBB Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #00ff88;
            margin-bottom: 10px;
        }
        
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .controls input {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
            width: 200px;
        }
        
        .controls button {
            padding: 10px 20px;
            font-size: 16px;
            background: #00ff88;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .controls button:hover {
            background: #00cc66;
        }
        
        .quick-buttons {
            margin-top: 15px;
        }
        
        .quick-buttons button {
            margin: 5px;
            padding: 8px 15px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .quick-buttons button:hover {
            background: #666;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .data-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }
        
        .data-card h3 {
            color: #00ff88;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #ccc;
        }
        
        .data-value {
            font-weight: bold;
        }
        
        .positive {
            color: #00ff88;
        }
        
        .negative {
            color: #ff4757;
        }
        
        .neutral {
            color: #ffa502;
        }
        
        .loading {
            text-align: center;
            color: #888;
            padding: 40px;
        }
        
        .error {
            color: #ff4757;
            text-align: center;
            padding: 20px;
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
        }
        
        .freqtrade-link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .freqtrade-link:hover {
            background: #0056b3;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Advanced Trading Dashboard</h1>
        <div class="status">
            <span>OpenBB Integration: <span style="color: #00ff88;">ACTIVE</span></span>
            <a href="http://127.0.0.1:8080" target="_blank" class="freqtrade-link">üìä Open Freqtrade UI</a>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="symbolInput" placeholder="Enter crypto symbol (BTC/USDT, ETH/USDT, etc.)" value="BTC/USDT">
        <button onclick="analyzeSymbol()">Analyze Symbol</button>
        
        <div class="quick-buttons">
            <button onclick="quickAnalyze('BTC/USDT')" style="background: #f39c12;">BTC/USDT</button>
            <button onclick="quickAnalyze('ETH/USDT')" style="background: #f39c12;">ETH/USDT</button>
            <button onclick="quickAnalyze('ADA/USDT')" style="background: #f39c12;">ADA/USDT</button>
            <button onclick="quickAnalyze('DOT/USDT')" style="background: #f39c12;">DOT/USDT</button>
            <button onclick="quickAnalyze('LTC/USDT')" style="background: #f39c12;">LTC/USDT</button>
            <button onclick="quickAnalyze('SOL/USDT')" style="background: #f39c12;">SOL/USDT</button>
        </div>
    </div>

    <div class="data-grid">
        <!-- Enhanced Signals -->
        <div class="data-card">
            <h3>üéØ Enhanced Signals</h3>
            <div id="enhancedSignals">
                <div class="loading">Loading signals...</div>
            </div>
        </div>

        <!-- Delta Analysis -->
        <div class="data-card">
            <h3>üîÑ Delta Analysis</h3>
            <div id="deltaAnalysis">
                <div class="loading">Loading delta data...</div>
            </div>
        </div>

        <!-- Volume Profile -->
        <div class="data-card">
            <h3>üìä Volume Profile</h3>
            <div id="volumeProfile">
                <div class="loading">Loading volume data...</div>
            </div>
        </div>

        <!-- Market Depth -->
        <div class="data-card">
            <h3>üìà Market Depth</h3>
            <div id="marketDepth">
                <div class="loading">Loading depth data...</div>
            </div>
        </div>

        <!-- Active Trades -->
        <div class="data-card full-width">
            <h3>üöÄ Active Trades (Live from Freqtrade)</h3>
            <div id="activeTrades">
                <div class="loading">Loading active trades...</div>
            </div>
        </div>

        <!-- Chart Patterns -->
        <div class="data-card full-width">
            <h3>üìà Chart Pattern Analysis</h3>
            <div id="chartPatterns">
                <div class="loading">Loading chart patterns...</div>
            </div>
        </div>

        <!-- Smart Money Tracker -->
        <div class="data-card full-width">
            <h3>üî• Smart Money Tracker</h3>
            <div id="smartMoneyData">
                <div class="loading">Loading smart money data...</div>
            </div>
        </div>

        <!-- Institutional Data -->
        <div class="data-card full-width">
            <h3>üè¶ Institutional Activity</h3>
            <div id="institutionalData">
                <div class="loading">Loading institutional data...</div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = 'BTC/USDT';

        function quickAnalyze(symbol) {
            document.getElementById('symbolInput').value = symbol;
            analyzeSymbol();
        }

        function analyzeSymbol() {
            currentSymbol = document.getElementById('symbolInput').value.trim();
            if (!currentSymbol) {
                alert('Please enter a symbol');
                return;
            }

            console.log('Analyzing symbol:', currentSymbol);
            
            // Reset all sections
            document.getElementById('enhancedSignals').innerHTML = '<div class="loading">Loading signals...</div>';
            document.getElementById('deltaAnalysis').innerHTML = '<div class="loading">Loading delta data...</div>';
            document.getElementById('volumeProfile').innerHTML = '<div class="loading">Loading volume data...</div>';
            document.getElementById('marketDepth').innerHTML = '<div class="loading">Loading depth data...</div>';
            document.getElementById('institutionalData').innerHTML = '<div class="loading">Loading institutional data...</div>';

            // Load all data
            loadEnhancedSignals();
            loadDeltaAnalysis();
            loadVolumeProfile();
            loadMarketDepth();
            loadActiveTrades();
            loadChartPatterns();
            loadSmartMoneyData();
            loadInstitutionalData();
        }

        function loadEnhancedSignals() {
            console.log('Loading enhanced signals for:', currentSymbol);
            fetch(`/api/openbb/analysis/${currentSymbol}`)
                .then(response => {
                    console.log('Enhanced signals response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Enhanced signals data:', data);
                    
                    if (data.error) {
                        document.getElementById('enhancedSignals').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    // Show data accuracy indicators
                    const isStock = !currentSymbol.includes('/');
                    const isCrypto = currentSymbol.includes('/');
                    
                    const html = `
                        <div style="background: #444; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em;">
                            üìä <strong>Data Source:</strong> ${isStock ? 'OpenBB + yfinance (REAL)' : 'CCXT Binance (REAL)'}
                        </div>
                        <div class="data-row">
                            <span class="data-label">Signal Strength:</span>
                            <span class="data-value ${getSignalClass(data.signal_strength)}">${data.signal_strength || 'neutral'}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Composite Score:</span>
                            <span class="data-value ${getScoreClass(data.composite_score)}">${(data.composite_score || 0).toFixed(3)} ‚úÖ</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Delta Score:</span>
                            <span class="data-value ${getScoreClass(data.delta_score)}">${(data.delta_score || 0).toFixed(3)} ‚úÖ</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Volume Score:</span>
                            <span class="data-value ${getScoreClass(data.volume_score)}">${(data.volume_score || 0).toFixed(3)} ‚úÖ</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Recommendation:</span>
                            <span class="data-value ${getRecommendationClass(data.entry_recommendation)}">${data.entry_recommendation || 'hold'}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Risk Level:</span>
                            <span class="data-value ${getRiskClass(data.risk_level)}">${data.risk_level || 'medium'}</span>
                        </div>
                    `;
                    
                    document.getElementById('enhancedSignals').innerHTML = html;
                })
                .catch(error => {
                    console.error('Enhanced signals error:', error);
                    document.getElementById('enhancedSignals').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function loadDeltaAnalysis() {
            console.log('Loading delta analysis for:', currentSymbol);
            fetch(`/api/openbb/delta/${currentSymbol}`)
                .then(response => {
                    console.log('Delta response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Delta data:', data);
                    
                    if (data.error) {
                        document.getElementById('deltaAnalysis').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    const html = `
                        <div class="data-row">
                            <span class="data-label">Cumulative Delta:</span>
                            <span class="data-value ${getScoreClass(data.cumulative_delta)}">${formatNumber(data.cumulative_delta || 0)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Net Delta:</span>
                            <span class="data-value ${getScoreClass(data.net_delta)}">${formatNumber(data.net_delta || 0)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Order Flow:</span>
                            <span class="data-value ${getScoreClass(data.order_flow_strength)}">${(data.order_flow_strength || 0).toFixed(3)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Divergence:</span>
                            <span class="data-value ${getScoreClass(data.delta_divergence)}">${(data.delta_divergence || 0).toFixed(3)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Institutional:</span>
                            <span class="data-value">${((data.institutional_flow || 0.5) * 100).toFixed(1)}%</span>
                        </div>
                    `;
                    
                    document.getElementById('deltaAnalysis').innerHTML = html;
                })
                .catch(error => {
                    console.error('Delta error:', error);
                    document.getElementById('deltaAnalysis').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function loadVolumeProfile() {
            console.log('Loading volume profile for:', currentSymbol);
            fetch(`/api/openbb/volume-profile/${currentSymbol}`)
                .then(response => {
                    console.log('Volume response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Volume data:', data);
                    
                    if (data.error) {
                        document.getElementById('volumeProfile').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    const html = `
                        <div class="data-row">
                            <span class="data-label">POC Price:</span>
                            <span class="data-value positive">$${(data.poc_price || 0).toFixed(2)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Value Area High:</span>
                            <span class="data-value">$${(data.value_area_high || 0).toFixed(2)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Value Area Low:</span>
                            <span class="data-value">$${(data.value_area_low || 0).toFixed(2)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Volume Imbalance:</span>
                            <span class="data-value ${getScoreClass(data.volume_imbalance)}">${(data.volume_imbalance || 0).toFixed(3)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Total Volume:</span>
                            <span class="data-value">${formatNumber(data.total_volume || 0)}</span>
                        </div>
                    `;
                    
                    document.getElementById('volumeProfile').innerHTML = html;
                })
                .catch(error => {
                    console.error('Volume error:', error);
                    document.getElementById('volumeProfile').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function loadMarketDepth() {
            console.log('Loading market depth for:', currentSymbol);
            fetch(`/api/openbb/market-depth/${currentSymbol}`)
                .then(response => {
                    console.log('Depth response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Depth data:', data);
                    
                    if (data.error) {
                        document.getElementById('marketDepth').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    const imbalanceClass = data.imbalance_ratio > 0.6 ? 'positive' : data.imbalance_ratio < 0.4 ? 'negative' : 'neutral';

                    const html = `
                        <div class="data-row">
                            <span class="data-label">Mid Price:</span>
                            <span class="data-value">$${(data.mid_price || 0).toFixed(2)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Spread:</span>
                            <span class="data-value">$${(data.spread || 0).toFixed(4)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Bid/Ask Ratio:</span>
                            <span class="data-value ${imbalanceClass}">${((data.imbalance_ratio || 0.5) * 100).toFixed(1)}%</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Bid Volume:</span>
                            <span class="data-value positive">${formatNumber(data.total_bid_volume || 0)}</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Ask Volume:</span>
                            <span class="data-value negative">${formatNumber(data.total_ask_volume || 0)}</span>
                        </div>
                    `;
                    
                    document.getElementById('marketDepth').innerHTML = html;
                })
                .catch(error => {
                    console.error('Depth error:', error);
                    document.getElementById('marketDepth').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function loadActiveTrades() {
            console.log('Loading active trades from Freqtrade...');
            fetch('/api/trades/active')
                .then(response => {
                    console.log('Active trades response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Active trades data:', data);
                    
                    if (!data || data.length === 0) {
                        document.getElementById('activeTrades').innerHTML = '<div style="text-align: center; color: #888;">No active trades</div>';
                        return;
                    }

                    let html = '<div style="display: grid; gap: 15px;">';
                    
                    data.forEach(trade => {
                        const profitClass = trade.profit_pct > 0 ? 'positive' : trade.profit_pct < 0 ? 'negative' : 'neutral';
                        
                        html += `
                            <div style="background: #333; padding: 15px; border-radius: 8px; border-left: 4px solid ${trade.profit_pct > 0 ? '#00ff88' : '#ff4757'};">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                                    <div>
                                        <div style="font-weight: bold; color: #00ff88;">${trade.pair}</div>
                                        <div style="color: #ccc; font-size: 0.9em;">${trade.side}</div>
                                    </div>
                                    <div>
                                        <div style="color: #ccc;">Amount</div>
                                        <div style="font-weight: bold;">${trade.amount.toFixed(6)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #ccc;">Entry Price</div>
                                        <div style="font-weight: bold;">$${trade.open_rate.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #ccc;">P&L</div>
                                        <div style="font-weight: bold;" class="${profitClass}">${trade.profit_pct.toFixed(2)}%</div>
                                        <div style="color: #ccc; font-size: 0.9em;">${trade.duration}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    document.getElementById('activeTrades').innerHTML = html;
                })
                .catch(error => {
                    console.error('Active trades error:', error);
                    document.getElementById('activeTrades').innerHTML = `<div class="error">Error loading trades: ${error.message}</div>`;
                });
        }

        function loadChartPatterns() {
            console.log('Loading chart patterns for:', currentSymbol);
            fetch(`/api/openbb/patterns/${currentSymbol}`)
                .then(response => {
                    console.log('Chart patterns response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Chart patterns data:', data);
                    
                    if (data.error) {
                        document.getElementById('chartPatterns').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    // SIMPLIFIED PATTERN DISPLAY
                    const bullishCount = (data.patterns || []).filter(p => p.signal === 'bullish').length;
                    const bearishCount = (data.patterns || []).filter(p => p.signal === 'bearish').length;
                    const topPattern = (data.patterns || [])[0];
                    
                    const html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #00ff88;">${bullishCount}</div>
                                <div style="color: #ccc;">Bullish Patterns</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #ff4757;">${bearishCount}</div>
                                <div style="color: #ccc;">Bearish Patterns</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: bold; color: #ffa502;">${(data.patterns || []).length}</div>
                                <div style="color: #ccc;">Total Patterns</div>
                            </div>
                        </div>
                        ${topPattern ? `
                            <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold; color: #00ff88; margin-bottom: 5px;">üîç Top Pattern</div>
                                <div style="font-size: 1.2em; margin-bottom: 5px;">${topPattern.pattern_type}</div>
                                <div style="color: ${topPattern.signal === 'bullish' ? '#00ff88' : '#ff4757'};">
                                    ${topPattern.signal.toUpperCase()} ‚Ä¢ ${(topPattern.confidence * 100).toFixed(0)}% confidence
                                </div>
                            </div>
                        ` : '<div style="text-align: center; color: #888;">No patterns detected</div>'}
                    `;
                    
                    document.getElementById('chartPatterns').innerHTML = html;
                })
                .catch(error => {
                    console.error('Chart patterns error:', error);
                    document.getElementById('chartPatterns').innerHTML = `<div class="error">Error loading patterns: ${error.message}</div>`;
                });
        }

        function loadSmartMoneyData() {
            console.log('Loading smart money data for:', currentSymbol);
            fetch(`/api/openbb/smart-money/${currentSymbol}`)
                .then(response => {
                    console.log('Smart money response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Smart money data:', data);
                    
                    if (data.error) {
                        document.getElementById('smartMoneyData').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    const analysis = data.comprehensive_analysis || {};
                    const signalClass = analysis.composite_signal === 'BULLISH' ? 'positive' : 
                                       analysis.composite_signal === 'BEARISH' ? 'negative' : 'neutral';
                    
                    const html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold;" class="${signalClass}">${analysis.composite_signal || 'NEUTRAL'}</div>
                                <div style="color: #ccc;">Smart Money Signal</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #ffa502;">${analysis.confidence || 'LOW'}</div>
                                <div style="color: #ccc;">Confidence</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #00ff88;">${((analysis.agreement_score || 0) * 100).toFixed(0)}%</div>
                                <div style="color: #ccc;">Agreement</div>
                            </div>
                        </div>
                        <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #00ff88; margin-bottom: 10px;">üìä Signal Breakdown</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                                <div>
                                    <div style="color: #ccc;">Options Flow</div>
                                    <div style="font-weight: bold;" class="${getSignalClass(analysis.options_signal)}">${analysis.options_signal || 'NEUTRAL'}</div>
                                </div>
                                <div>
                                    <div style="color: #ccc;">Insider Trading</div>
                                    <div style="font-weight: bold;" class="${getSignalClass(analysis.insider_signal)}">${analysis.insider_signal || 'NEUTRAL'}</div>
                                </div>
                                <div>
                                    <div style="color: #ccc;">Institutional</div>
                                    <div style="font-weight: bold;" class="${getSignalClass(analysis.institutional_signal)}">${analysis.institutional_signal || 'NEUTRAL'}</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; color: #00ff88; margin-bottom: 5px;">üéØ Recommendation</div>
                            <div style="font-size: 0.95em; color: #ccc;">${analysis.recommendation || 'No clear smart money signals detected'}</div>
                        </div>
                    `;
                    
                    document.getElementById('smartMoneyData').innerHTML = html;
                })
                .catch(error => {
                    console.error('Smart money error:', error);
                    document.getElementById('smartMoneyData').innerHTML = `<div class="error">Error loading smart money data: ${error.message}</div>`;
                });
        }

        function loadInstitutionalData() {
            console.log('Loading institutional data for:', currentSymbol);
            fetch(`/api/openbb/institutional/${currentSymbol}`)
                .then(response => {
                    console.log('Institutional response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Institutional data:', data);
                    
                    if (data.error) {
                        document.getElementById('institutionalData').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                        return;
                    }

                    const html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;">
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #00ff88;">${formatNumber(data.dark_pool_volume || 0)}</div>
                                <div style="color: #ccc; margin-top: 5px;">Dark Pool Volume</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #ffa502;">${(data.block_trades || []).length}</div>
                                <div style="color: #ccc; margin-top: 5px;">Block Trades</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: ${data.float_short > 0.2 ? '#ff4757' : '#ffa502'};">${((data.float_short || 0) * 100).toFixed(1)}%</div>
                                <div style="color: #ccc; margin-top: 5px;">Float Short</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: ${data.days_to_cover > 5 ? '#00ff88' : '#ffa502'};">${(data.days_to_cover || 0).toFixed(1)}</div>
                                <div style="color: #ccc; margin-top: 5px;">Days to Cover</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('institutionalData').innerHTML = html;
                })
                .catch(error => {
                    console.error('Institutional error:', error);
                    document.getElementById('institutionalData').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        // Helper functions
        function getSignalClass(strength) {
            if (!strength) return 'neutral';
            const s = strength.toLowerCase();
            if (s.includes('bullish')) return 'positive';
            if (s.includes('bearish')) return 'negative';
            return 'neutral';
        }

        function getScoreClass(score) {
            if (score > 0.1) return 'positive';
            if (score < -0.1) return 'negative';
            return 'neutral';
        }

        function getRiskClass(risk) {
            if (!risk) return 'neutral';
            if (risk.toLowerCase().includes('high')) return 'negative';
            if (risk.toLowerCase().includes('low')) return 'positive';
            return 'neutral';
        }

        function getRecommendationClass(rec) {
            if (!rec) return 'neutral';
            const r = rec.toLowerCase();
            if (r.includes('buy')) return 'positive';
            if (r.includes('sell')) return 'negative';
            return 'neutral';
        }

        function formatNumber(num) {
            if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (Math.abs(num) >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        // Auto-refresh every 60 seconds
        setInterval(() => {
            if (currentSymbol) {
                console.log('Auto-refreshing data...');
                analyzeSymbol();
            }
        }, 60000);

        // Load initial data
        window.onload = function() {
            console.log('Page loaded, analyzing initial symbol...');
            analyzeSymbol();
        };
    </script>
</body>
</html>
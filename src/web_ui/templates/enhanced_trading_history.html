<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Trading History - Detailed Trade Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa502 100%);
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
        }
        
        .trade-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.3);
            transition: all 0.3s ease;
        }
        
        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .profit-positive {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .profit-negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .logic-section {
            background: rgba(15, 23, 42, 0.6);
            border-left: 3px solid #667eea;
        }
        
        .score-bar {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        }
        
        .expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expandable.expanded {
            max-height: 2000px;
        }
        
        .reasoning-item {
            background: rgba(51, 65, 85, 0.3);
            border-left: 2px solid #667eea;
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl">
        <div class="container mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                        <i class="fas fa-brain text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Enhanced Trading History</h1>
                        <p class="text-sm opacity-90">Complete trade logic analysis and decision reasoning</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="exportTradeData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                    <button onclick="window.location.reload()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-400">Loading detailed trade history...</p>
        </div>

        <!-- Statistics Summary -->
        <div id="statisticsSection" class="hidden mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Trades</p>
                            <p id="totalTrades" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-blue-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-chart-line text-2xl text-blue-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Win Rate</p>
                            <p id="winRate" class="text-2xl font-bold text-white">0%</p>
                        </div>
                        <div class="bg-green-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-target text-2xl text-green-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total P&L</p>
                            <p id="totalPnL" class="text-2xl font-bold text-white">$0.00</p>
                        </div>
                        <div class="bg-purple-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-dollar-sign text-2xl text-purple-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Avg Duration</p>
                            <p id="avgDuration" class="text-2xl font-bold text-white">0h</p>
                        </div>
                        <div class="bg-orange-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-clock text-2xl text-orange-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades List -->
        <div id="tradesContainer" class="hidden space-y-6">
            <!-- Trade cards will be inserted here -->
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-red-400">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <h3 class="text-lg font-medium mb-2">Error Loading Trade History</h3>
                <p class="text-gray-400" id="errorMessage">Unable to load trade data</p>
            </div>
        </div>
    </div>

    <script>
        let tradesData = [];

        // Load trade history on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTradeHistory();
        });

        async function loadTradeHistory() {
            try {
                console.log('ðŸ“Š Loading enhanced trade history...');
                
                const response = await fetch('/api/trades/history');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                tradesData = data.closed_trades || [];
                const statistics = data.statistics || {};
                
                console.log(`âœ… Loaded ${tradesData.length} trades with detailed logic`);
                
                // Update statistics
                updateStatistics(statistics);
                
                // Render trades
                renderTrades(tradesData);
                
                // Show content, hide loading
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('statisticsSection').classList.remove('hidden');
                document.getElementById('tradesContainer').classList.remove('hidden');
                
            } catch (error) {
                console.error('âŒ Error loading trade history:', error);
                showError(error.message);
            }
        }

        function updateStatistics(stats) {
            document.getElementById('totalTrades').textContent = stats.total_trades || 0;
            document.getElementById('winRate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
            
            const totalPnL = stats.total_profit_abs || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = `$${totalPnL.toFixed(2)}`;
            pnlElement.className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('avgDuration').textContent = `${(stats.avg_duration_hours || 0).toFixed(1)}h`;
        }

        function renderTrades(trades) {
            const container = document.getElementById('tradesContainer');
            
            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium mb-2">No Trades Found</h3>
                            <p>Start trading to see your detailed trade history here</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = trades.map((trade, index) => createTradeCard(trade, index)).join('');
        }

        function createTradeCard(trade, index) {
            const profitClass = trade.profit_pct >= 0 ? 'profit-positive' : 'profit-negative';
            const profitIcon = trade.profit_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
                <div class="trade-card rounded-xl p-6">
                    <!-- Trade Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-blue-900 bg-opacity-30 p-3 rounded-xl">
                                <i class="fas fa-exchange-alt text-blue-400"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">${trade.pair}</h3>
                                <p class="text-gray-400 text-sm">Trade #${trade.trade_id} â€¢ ${trade.strategy}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <i class="fas ${profitIcon} text-sm"></i>
                                <span class="text-2xl font-bold ${profitClass.includes('positive') ? 'text-green-400' : 'text-red-400'}">
                                    ${trade.profit_pct >= 0 ? '+' : ''}${trade.profit_pct.toFixed(2)}%
                                </span>
                            </div>
                            <p class="text-gray-400 text-sm">${trade.profit_pct >= 0 ? '+' : ''}$${trade.profit_abs.toFixed(2)}</p>
                        </div>
                    </div>

                    <!-- Trade Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Entry Price</p>
                            <p class="text-white font-medium">$${trade.open_rate.toFixed(6)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Exit Price</p>
                            <p class="text-white font-medium">$${trade.close_rate.toFixed(6)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Duration</p>
                            <p class="text-white font-medium">${trade.exit_logic.duration_hours.toFixed(1)}h</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Exit Type</p>
                            <p class="text-white font-medium">${formatExitType(trade.exit_logic.exit_type)}</p>
                        </div>
                    </div>

                    <!-- Entry Logic Summary -->
                    <div class="mb-4">
                        <h4 class="text-white font-medium mb-3 flex items-center">
                            <i class="fas fa-sign-in-alt text-green-400 mr-2"></i>
                            Entry Logic Summary
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="logic-section rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm">Technical</span>
                                    <span class="text-white font-medium">${(trade.entry_logic.technical_score * 100).toFixed(0)}%</span>
                                </div>
                                <div class="score-bar">
                                    <div class="h-full rounded" style="width: ${trade.entry_logic.technical_score * 100}%; background: ${getScoreColor(trade.entry_logic.technical_score)}"></div>
                                </div>
                            </div>
                            <div class="logic-section rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm">On-Chain</span>
                                    <span class="text-white font-medium">${(trade.entry_logic.onchain_score * 100).toFixed(0)}%</span>
                                </div>
                                <div class="score-bar">
                                    <div class="h-full rounded" style="width: ${trade.entry_logic.onchain_score * 100}%; background: ${getScoreColor(trade.entry_logic.onchain_score)}"></div>
                                </div>
                            </div>
                            <div class="logic-section rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm">Sentiment</span>
                                    <span class="text-white font-medium">${(trade.entry_logic.sentiment_score * 100).toFixed(0)}%</span>
                                </div>
                                <div class="score-bar">
                                    <div class="h-full rounded" style="width: ${trade.entry_logic.sentiment_score * 100}%; background: ${getScoreColor(trade.entry_logic.sentiment_score)}"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expand/Collapse Button -->
                    <div class="text-center mb-4">
                        <button onclick="toggleTradeDetails(${index})" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg transition-all">
                            <i class="fas fa-chevron-down mr-2" id="chevron-${index}"></i>
                            <span id="toggle-text-${index}">Show Detailed Analysis</span>
                        </button>
                    </div>

                    <!-- Detailed Analysis (Expandable) -->
                    <div id="details-${index}" class="expandable">
                        <!-- Entry Logic Details -->
                        <div class="mb-6">
                            <h4 class="text-white font-medium mb-4 flex items-center">
                                <i class="fas fa-chart-line text-green-400 mr-2"></i>
                                Entry Decision Analysis
                            </h4>
                            
                            <!-- Technical Analysis -->
                            <div class="mb-4">
                                <h5 class="text-gray-300 font-medium mb-2">Technical Analysis (Weight: 40%)</h5>
                                <div class="space-y-2">
                                    ${trade.entry_logic.technical_reasoning.map(reason => `
                                        <div class="reasoning-item rounded p-2 text-sm text-gray-300">
                                            <i class="fas fa-check-circle text-green-400 mr-2"></i>${reason}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- On-Chain Analysis -->
                            <div class="mb-4">
                                <h5 class="text-gray-300 font-medium mb-2">On-Chain Analysis (Weight: 35%)</h5>
                                <div class="space-y-2">
                                    ${trade.entry_logic.onchain_reasoning.map(reason => `
                                        <div class="reasoning-item rounded p-2 text-sm text-gray-300">
                                            <i class="fas fa-link text-blue-400 mr-2"></i>${reason}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Sentiment Analysis -->
                            <div class="mb-4">
                                <h5 class="text-gray-300 font-medium mb-2">Sentiment Analysis (Weight: 25%)</h5>
                                <div class="space-y-2">
                                    ${trade.entry_logic.sentiment_reasoning.map(reason => `
                                        <div class="reasoning-item rounded p-2 text-sm text-gray-300">
                                            <i class="fas fa-heart text-purple-400 mr-2"></i>${reason}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Composite Decision -->
                            <div class="logic-section rounded-lg p-4">
                                <h5 class="text-white font-medium mb-2">Final Decision</h5>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-300">Composite Score:</span>
                                    <span class="text-xl font-bold text-white">${(trade.entry_logic.composite_score * 100).toFixed(1)}%</span>
                                </div>
                                <div class="score-bar mt-2">
                                    <div class="h-full rounded" style="width: ${trade.entry_logic.composite_score * 100}%; background: ${getScoreColor(trade.entry_logic.composite_score)}"></div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Market Regime: ${formatMarketRegime(trade.entry_logic.market_regime)}</p>
                            </div>
                        </div>

                        <!-- Exit Logic Details -->
                        <div class="mb-6">
                            <h4 class="text-white font-medium mb-4 flex items-center">
                                <i class="fas fa-sign-out-alt text-red-400 mr-2"></i>
                                Exit Decision Analysis
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="logic-section rounded-lg p-4">
                                    <h5 class="text-white font-medium mb-2">Exit Details</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Exit Type:</span>
                                            <span class="text-white">${formatExitType(trade.exit_logic.exit_type)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">ROI Reached:</span>
                                            <span class="text-white">${trade.exit_logic.roi_reached ? 'Yes' : 'No'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Stop Loss Hit:</span>
                                            <span class="text-white">${trade.exit_logic.stop_loss_hit ? 'Yes' : 'No'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Trailing Stop:</span>
                                            <span class="text-white">${trade.exit_logic.trailing_stop_used ? 'Yes' : 'No'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="logic-section rounded-lg p-4">
                                    <h5 class="text-white font-medium mb-2">Performance Metrics</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Max Profit:</span>
                                            <span class="text-green-400">+${trade.performance_metrics.max_profit_pct.toFixed(2)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Max Drawdown:</span>
                                            <span class="text-red-400">${trade.performance_metrics.max_drawdown_pct.toFixed(2)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Efficiency:</span>
                                            <span class="text-white">${trade.performance_metrics.efficiency_ratio.toFixed(3)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Risk/Reward:</span>
                                            <span class="text-white">${trade.performance_metrics.risk_reward_ratio.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Exit Reasoning -->
                            <div class="mt-4">
                                <h5 class="text-gray-300 font-medium mb-2">Exit Reasoning</h5>
                                <div class="space-y-2">
                                    ${trade.exit_logic.exit_reasoning.map(reason => `
                                        <div class="reasoning-item rounded p-2 text-sm text-gray-300">
                                            <i class="fas fa-info-circle text-yellow-400 mr-2"></i>${reason}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Trade Timeline -->
                        <div class="mb-6">
                            <h4 class="text-white font-medium mb-4 flex items-center">
                                <i class="fas fa-clock text-blue-400 mr-2"></i>
                                Trade Timeline
                            </h4>
                            <div class="logic-section rounded-lg p-4">
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                        <div>
                                            <p class="text-white font-medium">Trade Opened</p>
                                            <p class="text-gray-400 text-sm">${new Date(trade.open_date).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 ${trade.profit_pct >= 0 ? 'bg-green-400' : 'bg-red-400'} rounded-full"></div>
                                        <div>
                                            <p class="text-white font-medium">Trade Closed</p>
                                            <p class="text-gray-400 text-sm">${new Date(trade.close_date).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleTradeDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);
            const toggleText = document.getElementById(`toggle-text-${index}`);
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
                toggleText.textContent = 'Show Detailed Analysis';
            } else {
                details.classList.add('expanded');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
                toggleText.textContent = 'Hide Detailed Analysis';
            }
        }

        function getScoreColor(score) {
            if (score >= 0.7) return '#10b981'; // Green
            if (score >= 0.5) return '#f59e0b'; // Yellow
            return '#ef4444'; // Red
        }

        function formatExitType(exitType) {
            const types = {
                'profit_target': 'Profit Target',
                'stop_loss': 'Stop Loss',
                'trailing_stop': 'Trailing Stop',
                'manual': 'Manual Exit',
                'timeout': 'Timeout',
                'other': 'Other'
            };
            return types[exitType] || exitType;
        }

        function formatMarketRegime(regime) {
            const regimes = {
                'bull_market': 'Bull Market',
                'bear_market': 'Bear Market',
                'sideways': 'Sideways',
                'volatile': 'High Volatility',
                'unknown': 'Unknown'
            };
            return regimes[regime] || regime;
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function exportTradeData() {
            if (tradesData.length === 0) {
                alert('No trade data to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['Trade ID', 'Pair', 'Entry Date', 'Exit Date', 'Entry Price', 'Exit Price', 'Profit %', 'Profit $', 'Duration (h)', 'Exit Type', 'Technical Score', 'OnChain Score', 'Sentiment Score', 'Composite Score'];
            const csvData = tradesData.map(trade => [
                trade.trade_id,
                trade.pair,
                trade.open_date,
                trade.close_date,
                trade.open_rate,
                trade.close_rate,
                trade.profit_pct,
                trade.profit_abs,
                trade.exit_logic.duration_hours,
                trade.exit_logic.exit_type,
                trade.entry_logic.technical_score,
                trade.entry_logic.onchain_score,
                trade.entry_logic.sentiment_score,
                trade.entry_logic.composite_score
            ]);
            
            const csv = [headers, ...csvData].map(row => row.join(',')).join('\\n');
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadTradeHistory();
        }, 300000);
    </script>
</body>
</html>"
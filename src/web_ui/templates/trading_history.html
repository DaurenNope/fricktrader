<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading History - Complete Trade Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa502 100%);
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
        }
        
        .profit-positive {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .profit-negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .trade-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.3);
            transition: all 0.3s ease;
        }
        
        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .notes-section {
            background: rgba(15, 23, 42, 0.6);
            border-left: 3px solid #667eea;
        }
        
        .note-item {
            background: rgba(51, 65, 85, 0.3);
            border-left: 2px solid #10b981;
        }
        
        .expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expandable.expanded {
            max-height: 1000px;
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl">
        <div class="container mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-xl">
                        <i class="fas fa-history text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Trading History</h1>
                        <p class="text-sm opacity-90">Complete trade analysis with detailed logic and reasoning</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="exportData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="window.location.reload()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-400">Loading trading history...</p>
        </div>

        <!-- Statistics Summary -->
        <div id="statisticsSection" class="hidden mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Trades</p>
                            <p id="totalTrades" class="text-2xl font-bold text-white">0</p>
                        </div>
                        <div class="bg-blue-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-chart-line text-2xl text-blue-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Win Rate</p>
                            <p id="winRate" class="text-2xl font-bold text-white">0%</p>
                        </div>
                        <div class="bg-green-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-target text-2xl text-green-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total P&L</p>
                            <p id="totalPnL" class="text-2xl font-bold text-white">$0.00</p>
                        </div>
                        <div class="bg-purple-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-dollar-sign text-2xl text-purple-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="trade-card rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Avg Duration</p>
                            <p id="avgDuration" class="text-2xl font-bold text-white">0h</p>
                        </div>
                        <div class="bg-orange-900 bg-opacity-30 p-3 rounded-xl">
                            <i class="fas fa-clock text-2xl text-orange-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades List -->
        <div id="tradesContainer" class="hidden space-y-6">
            <!-- Trade cards will be inserted here -->
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-red-400">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <h3 class="text-lg font-medium mb-2">Error Loading Trade History</h3>
                <p class="text-gray-400" id="errorMessage">Unable to load trade data</p>
            </div>
        </div>
    </div>

    <script>
        let tradesData = [];

        // Load trade history on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTradingHistory();
        });

        async function loadTradingHistory() {
            try {
                console.log('📊 Loading trading history with detailed logic...');
                
                const response = await fetch('/api/trades/history');
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Get response text first to debug JSON issues
                const responseText = await response.text();
                console.log('Raw response length:', responseText.length);
                
                // Try to parse JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('JSON Parse Error:', jsonError);
                    console.error('Response text:', responseText.substring(0, 500) + '...');
                    throw new Error('Invalid JSON response from server');
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                tradesData = data.closed_trades || [];
                const statistics = data.statistics || {};
                
                console.log(`✅ Loaded ${tradesData.length} trades with detailed logic`);
                
                // Update statistics
                updateStatistics(statistics);
                
                // Render trades
                renderTrades(tradesData);
                
                // Show content, hide loading
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('statisticsSection').classList.remove('hidden');
                document.getElementById('tradesContainer').classList.remove('hidden');
                
            } catch (error) {
                console.error('❌ Error loading trading history:', error);
                showError(error.message);
            }
        }

        function updateStatistics(stats) {
            document.getElementById('totalTrades').textContent = stats.total_trades || 0;
            document.getElementById('winRate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
            
            const totalPnL = stats.total_profit_abs || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = `$${totalPnL.toFixed(2)}`;
            pnlElement.className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('avgDuration').textContent = `${(stats.avg_duration_hours || 0).toFixed(1)}h`;
        }

        function renderTrades(trades) {
            const container = document.getElementById('tradesContainer');
            
            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium mb-2">No Trades Found</h3>
                            <p>Start trading to see your detailed trade history here</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = trades.map((trade, index) => createTradeCard(trade, index)).join('');
        }

        function createTradeCard(trade, index) {
            const profitClass = trade.profit_pct >= 0 ? 'profit-positive' : 'profit-negative';
            const profitIcon = trade.profit_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            // Safely access nested properties
            const entryLogic = trade.entry_logic || {};
            const exitLogic = trade.exit_logic || {};
            const performanceMetrics = trade.performance_metrics || {};
            
            return `
                <div class="trade-card rounded-xl p-6">
                    <!-- Trade Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-blue-900 bg-opacity-30 p-3 rounded-xl">
                                <i class="fas fa-exchange-alt text-blue-400"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">${trade.pair || 'Unknown'}</h3>
                                <p class="text-gray-400 text-sm">Trade #${trade.trade_id || index + 1} • ${trade.strategy || 'MultiSignalStrategy'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-2">
                                <i class="fas ${profitIcon} text-sm"></i>
                                <span class="text-2xl font-bold ${profitClass.includes('positive') ? 'text-green-400' : 'text-red-400'}">
                                    ${trade.profit_pct >= 0 ? '+' : ''}${(trade.profit_pct || 0).toFixed(2)}%
                                </span>
                            </div>
                            <p class="text-gray-400 text-sm">${trade.profit_pct >= 0 ? '+' : ''}$${(trade.profit_abs || 0).toFixed(2)}</p>
                        </div>
                    </div>

                    <!-- Trade Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Entry Price</p>
                            <p class="text-white font-medium">$${(trade.open_rate || 0).toFixed(6)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Exit Price</p>
                            <p class="text-white font-medium">$${(trade.close_rate || 0).toFixed(6)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Duration</p>
                            <p class="text-white font-medium">${(exitLogic.duration_hours || 0).toFixed(1)}h</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs uppercase tracking-wide">Exit Type</p>
                            <p class="text-white font-medium">${formatExitType(exitLogic.exit_type || 'unknown')}</p>
                        </div>
                    </div>

                    <!-- Trade Notes Button -->
                    <div class="text-center mb-4">
                        <button onclick="toggleTradeNotes(${index})" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg transition-all">
                            <i class="fas fa-sticky-note mr-2"></i>
                            <span id="notes-toggle-${index}">Show Trade Notes</span>
                        </button>
                    </div>

                    <!-- Trade Notes (Expandable) -->
                    <div id="notes-${index}" class="expandable">
                        <div class="notes-section rounded-lg p-4">
                            <h4 class="text-white font-medium mb-4 flex items-center">
                                <i class="fas fa-clipboard-list text-blue-400 mr-2"></i>
                                Complete Trade Logic & Notes
                            </h4>
                            
                            <!-- Entry Notes -->
                            <div class="mb-6">
                                <h5 class="text-green-400 font-medium mb-3 flex items-center">
                                    <i class="fas fa-sign-in-alt mr-2"></i>
                                    Why This Trade Was Opened
                                </h5>
                                
                                <div class="space-y-2 mb-4">
                                    <div class="note-item rounded p-3">
                                        <p class="text-sm text-gray-300 mb-2"><strong>Technical Analysis (${((entryLogic.technical_score || 0) * 100).toFixed(0)}% score):</strong></p>
                                        ${(entryLogic.technical_reasoning || ['No technical analysis available']).map(reason => `
                                            <p class="text-sm text-gray-400 ml-4">• ${reason}</p>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="note-item rounded p-3">
                                        <p class="text-sm text-gray-300 mb-2"><strong>On-Chain Analysis (${((entryLogic.onchain_score || 0) * 100).toFixed(0)}% score):</strong></p>
                                        ${(entryLogic.onchain_reasoning || ['No on-chain analysis available']).map(reason => `
                                            <p class="text-sm text-gray-400 ml-4">• ${reason}</p>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="note-item rounded p-3">
                                        <p class="text-sm text-gray-300 mb-2"><strong>Sentiment Analysis (${((entryLogic.sentiment_score || 0) * 100).toFixed(0)}% score):</strong></p>
                                        ${(entryLogic.sentiment_reasoning || ['No sentiment analysis available']).map(reason => `
                                            <p class="text-sm text-gray-400 ml-4">• ${reason}</p>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-700 rounded p-3">
                                    <p class="text-white font-medium">Final Entry Decision: ${((entryLogic.composite_score || 0) * 100).toFixed(1)}% confidence</p>
                                    <p class="text-gray-400 text-sm">Market Regime: ${formatMarketRegime(entryLogic.market_regime || 'unknown')}</p>
                                </div>
                            </div>

                            <!-- Exit Notes -->
                            <div class="mb-6">
                                <h5 class="text-red-400 font-medium mb-3 flex items-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i>
                                    Why This Trade Was Closed
                                </h5>
                                
                                <div class="space-y-2">
                                    ${(exitLogic.exit_reasoning || ['No exit reasoning available']).map(reason => `
                                        <div class="note-item rounded p-3">
                                            <p class="text-sm text-gray-300">• ${reason}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="bg-slate-700 rounded p-3 mt-3">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="text-gray-400">Exit Method:</p>
                                            <p class="text-white">${formatExitType(exitLogic.exit_type || 'unknown')}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400">Trailing Stop Used:</p>
                                            <p class="text-white">${exitLogic.trailing_stop_used ? 'Yes' : 'No'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400">ROI Target Hit:</p>
                                            <p class="text-white">${exitLogic.roi_reached ? 'Yes' : 'No'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-400">Stop Loss Hit:</p>
                                            <p class="text-white">${exitLogic.stop_loss_hit ? 'Yes' : 'No'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Notes -->
                            <div class="mb-4">
                                <h5 class="text-purple-400 font-medium mb-3 flex items-center">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    Performance Analysis
                                </h5>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="bg-slate-700 rounded p-3">
                                        <p class="text-gray-400">Max Profit Reached</p>
                                        <p class="text-green-400 font-medium">+${(performanceMetrics.max_profit_pct || 0).toFixed(2)}%</p>
                                    </div>
                                    <div class="bg-slate-700 rounded p-3">
                                        <p class="text-gray-400">Max Drawdown</p>
                                        <p class="text-red-400 font-medium">${(performanceMetrics.max_drawdown_pct || 0).toFixed(2)}%</p>
                                    </div>
                                    <div class="bg-slate-700 rounded p-3">
                                        <p class="text-gray-400">Efficiency Ratio</p>
                                        <p class="text-white font-medium">${(performanceMetrics.efficiency_ratio || 0).toFixed(3)}</p>
                                    </div>
                                    <div class="bg-slate-700 rounded p-3">
                                        <p class="text-gray-400">Risk/Reward</p>
                                        <p class="text-white font-medium">${(performanceMetrics.risk_reward_ratio || 0).toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div class="bg-slate-700 rounded p-3">
                                <h5 class="text-blue-400 font-medium mb-2">Trade Timeline</h5>
                                <div class="text-sm space-y-1">
                                    <p class="text-gray-300">Opened: ${trade.open_date ? new Date(trade.open_date).toLocaleString() : 'Unknown'}</p>
                                    <p class="text-gray-300">Closed: ${trade.close_date ? new Date(trade.close_date).toLocaleString() : 'Unknown'}</p>
                                    <p class="text-gray-300">Duration: ${(exitLogic.duration_hours || 0).toFixed(1)} hours</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleTradeNotes(index) {
            const notes = document.getElementById(`notes-${index}`);
            const toggle = document.getElementById(`notes-toggle-${index}`);
            
            if (notes.classList.contains('expanded')) {
                notes.classList.remove('expanded');
                toggle.textContent = 'Show Trade Notes';
            } else {
                notes.classList.add('expanded');
                toggle.textContent = 'Hide Trade Notes';
            }
        }

        function formatExitType(exitType) {
            const types = {
                'profit_target': 'Profit Target',
                'stop_loss': 'Stop Loss',
                'trailing_stop': 'Trailing Stop',
                'manual': 'Manual Exit',
                'timeout': 'Timeout',
                'roi': 'ROI Target',
                'other': 'Other',
                'unknown': 'Unknown'
            };
            return types[exitType] || exitType;
        }

        function formatMarketRegime(regime) {
            const regimes = {
                'bull_market': 'Bull Market',
                'bear_market': 'Bear Market',
                'sideways': 'Sideways Market',
                'volatile': 'High Volatility',
                'unknown': 'Unknown'
            };
            return regimes[regime] || regime;
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function exportData() {
            if (tradesData.length === 0) {
                alert('No trade data to export');
                return;
            }
            
            // Create comprehensive CSV with trade logic
            const headers = [
                'Trade ID', 'Pair', 'Entry Date', 'Exit Date', 'Entry Price', 'Exit Price', 
                'Profit %', 'Profit $', 'Duration (h)', 'Exit Type', 'Technical Score', 
                'OnChain Score', 'Sentiment Score', 'Composite Score', 'Market Regime',
                'Max Profit %', 'Max Drawdown %', 'Risk/Reward', 'Entry Reasoning', 'Exit Reasoning'
            ];
            
            const csvData = tradesData.map(trade => {
                const entryLogic = trade.entry_logic || {};
                const exitLogic = trade.exit_logic || {};
                const performanceMetrics = trade.performance_metrics || {};
                
                return [
                    trade.trade_id || '',
                    trade.pair || '',
                    trade.open_date || '',
                    trade.close_date || '',
                    trade.open_rate || 0,
                    trade.close_rate || 0,
                    trade.profit_pct || 0,
                    trade.profit_abs || 0,
                    exitLogic.duration_hours || 0,
                    exitLogic.exit_type || '',
                    entryLogic.technical_score || 0,
                    entryLogic.onchain_score || 0,
                    entryLogic.sentiment_score || 0,
                    entryLogic.composite_score || 0,
                    entryLogic.market_regime || '',
                    performanceMetrics.max_profit_pct || 0,
                    performanceMetrics.max_drawdown_pct || 0,
                    performanceMetrics.risk_reward_ratio || 0,
                    (entryLogic.technical_reasoning || []).join('; '),
                    (exitLogic.exit_reasoning || []).join('; ')
                ];
            });
            
            const csv = [headers, ...csvData].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\\n');
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_history_with_logic_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadTradingHistory();
        }, 300000);
    </script>
</body>
</html>"